# Обновление формата запросов к DeepSeek API и очистка базы данных продуктов

В данном обновлении были внесены следующие изменения:

## 1. Обновление формата запросов к DeepSeek API

### Что было изменено:
- Упрощен формат запросов к DeepSeek API
- Система теперь запрашивает данные в формате: "[название на английском] | [калории] [белки] [жиры] [углеводы]"
- Обновлены системные сообщения для получения более точных ответов
- Унифицирована логика извлечения данных из ответа API
- Добавлена автоматическая транслитерация и стандартизация названий продуктов

### Расположение изменений:
- `handlers/food_handlers.py`: функция `call_ai_api()` и обработка ответов в обеих точках использования (основной запрос и пользовательский запрос)

### Новый формат запроса:
- **Системное сообщение**: "You are a nutrition expert. Provide nutritional data per 100g in this format: [standardized_name_in_english] | [calories] [proteins] [fats] [carbs]. Example: 'Apple | 52 0.3 0.2 14'. For branded products like 'Рафаэло', use proper product name: 'Raffaello | 580 8 40 45'."
- **Пользовательское сообщение**: "Nutritional value of '{food_name}' per 100g? Respond ONLY with standardized name and 4 numbers using the exact format: name | calories proteins fats carbs"
- **Ожидаемый ответ**: "Apple | 52 0.3 0.2 14" (название, вертикальная черта, затем 4 числа через пробел)

## 2. Инструменты для очистки базы данных продуктов

### Скрипт для очистки базы данных (`database/cleanup_products.py`):
- Создает резервную копию базы данных перед началом очистки
- Удаляет дубликаты продуктов
- Стандартизирует названия продуктов
- Проверяет и исправляет некорректные значения пищевой ценности
- Проверяет и исправляет связи между штрих-кодами и продуктами

### Как запустить:
```bash
python database/cleanup_products.py
```

### Основные функции:
- `backup_database()` - создает резервную копию базы данных
- `standardize_name()` - нормализует названия продуктов
- `validate_nutrition_values()` - проверяет корректность значений пищевой ценности
- `remove_duplicates()` - удаляет дубликаты продуктов
- `update_product_names()` - обновляет названия продуктов в базе данных
- `fix_invalid_values()` - исправляет некорректные значения пищевой ценности
- `check_barcode_relations()` - проверяет и исправляет связи между штрих-кодами и продуктами

## 3. Скрипт для автоматизации транслитерации названий (`food_name_normalizer.py`):

### Функциональность:
- Автоматически получает стандартизированные названия продуктов на английском через DeepSeek API
- Одновременно с названием получает данные о пищевой ценности (КБЖУ)
- Обновляет базу данных, применяя новые названия и значения
- Корректно обрабатывает брендовые продукты (например, "Рафаэло" -> "Raffaello")
- Поддерживает режим тестирования для проверки работы с отдельными продуктами

### Как запустить:
```bash
# Обновление всей базы данных
python food_name_normalizer.py

# Обновление только первых N продуктов (для тестирования)
python food_name_normalizer.py --limit 10

# Тестирование конкретных продуктов без изменения базы
python food_name_normalizer.py --test "Яблоко" "Рафаэло" "Куриная грудка"
```

### Примеры работы:
- "Яблоко" -> "Apple" с КБЖУ: 52 ккал, 0.3г белка, 0.2г жира, 14г углеводов
- "Рафаэло" -> "Raffaello" с КБЖУ: 580 ккал, 8г белка, 40г жира, 45г углеводов
- "Куриная грудка" -> "Chicken breast" с КБЖУ: 165 ккал, 31г белка, 3.6г жира, 0г углеводов

## 4. Скрипт для тестирования API DeepSeek (`test_food_api.py`):

### Функциональность:
- Тестирует API DeepSeek с новым форматом запросов
- Проверяет обработку ответов и извлечение значений пищевой ценности
- Проверяет корректность стандартизации и транслитерации названий продуктов
- Валидирует полученные данные на соответствие ожидаемым диапазонам
- Сохраняет результаты тестирования в JSON-файл
- Выводит подробную статистику по успешным и неуспешным запросам

### Как запустить:
```bash
# Тестирование всех продуктов из предустановленного списка
python test_food_api.py

# Тестирование конкретных продуктов
python test_food_api.py "Яблоко" "Рафаэло" "Куриная грудка"
```

### Результаты тестирования:
- Успешные запросы отмечаются символом ✅
- Неуспешные запросы отмечаются символом ❌
- Для каждого продукта выводится информация о полученных значениях пищевой ценности и правильности названия
- Результаты сохраняются в файл `test_food_api_results.json`

## 5. Рекомендации по дальнейшим улучшениям

1. **Дополнительные проверки качества данных:**
   - Добавить более строгую валидацию пищевой ценности
   - Реализовать механизм автоматического исправления некорректных значений

2. **Улучшение логики обработки ответов DeepSeek:**
   - Добавить более сложные шаблоны для извлечения данных из нестандартных ответов
   - Реализовать механизм кэширования запросов для экономии API запросов

3. **Расширение функционала:**
   - Добавить возможность получения дополнительной информации о продукте (микроэлементы, витамины и т.д.)
   - Реализовать механизм для обновления существующих продуктов на основе новых данных от API

4. **Улучшение пользовательского опыта:**
   - Добавить возможность выбора из нескольких вариантов продуктов, если название неоднозначно
   - Реализовать автоматическое предложение похожих продуктов, если конкретный продукт не найден в базе данных 